<!DOCTYPE html>
<html>
<head>
    <title>Cytoscape.js in JavaFX</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.30.2/cytoscape.min.js"></script>
    <script src="https://unpkg.com/cytoscape-edgehandles@4.0.1/cytoscape-edgehandles.js"></script>
    <style>
        #cy {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background-color: #f5f6fa;
            z-index: 0;
        }
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        .eh-handle {
            background-color: red;
            width: 12px;
            height: 12px;
            border: 2px solid darkred;
            border-radius: 50%;
        }
        .eh-preview, .eh-ghost-edge {
            line-color: red;
            target-arrow-color: red;
        }
    </style>
</head>
<body>
    <div id="cy"></div>
    <script>
        // Debugging function to log to JavaFX console
        function log(message) {
            console.log(message);
            if (window.JavaBridge) {
                window.JavaBridge.log(message);
            }
        }

        try {
            // SVG as data URL for the node background
            const svgCircle = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path fill="#5B9BD5" d="M64 320C64 178.6 178.6 64 320 64C461.4 64 576 178.6 576 320C576 461.4 461.4 576 320 576C178.6 576 64 461.4 64 320z"/></svg>');

            // Initialize Cytoscape.js
            var cy = cytoscape({
                container: document.getElementById('cy'),
                elements: [
                    { data: { id: 'a' } },
                    { data: { id: 'b' } },
                    { data: { id: 'ab', source: 'a', target: 'b' } }
                ],
                style: [
                    {
                        selector: 'node',
                        style: {
                            'shape': 'ellipse',
                            'width': 60,
                            'height': 60,
                            'background-image': svgCircle,
                            'background-fit': 'cover',
                            'background-clip': 'node',
                            'background-opacity': 0, // Make default background transparent
                            'label': 'data(id)',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'color': '#ffffff',
                            'font-size': '14px',
                            'font-weight': '600',
                            'text-outline-width': 2,
                            'text-outline-color': '#2F6396',
                            'border-width': 2,
                            'border-color': '#2F6396',
                            'shadow-color': '#2F6396',
                            'shadow-opacity': 0.3,
                            'shadow-offset-x': 0,
                            'shadow-offset-y': 2,
                            'transition-property': 'border-color',
                            'transition-duration': '0.3s'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 2,
                            'line-color': '#A9B7C6',
                            'target-arrow-color': '#A9B7C6',
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier',
                            'label': 'data(label)',
                            'font-size': '10px',
                            'color': '#666',
                            'text-rotation': 'autorotate',
                            'text-margin-y': -10,
                            'transition-property': 'line-color',
                            'transition-duration': '0.3s'
                        }
                    },
                    {
                        selector: 'node:hover',
                        style: {
                            'border-color': '#1A4A7A',
                            'shadow-opacity': 0.5
                        }
                    },
                    {
                        selector: 'edge:hover',
                        style: {
                            'line-color': '#7A8B9A',
                            'target-arrow-color': '#7A8B9A'
                        }
                    }
                ],
                layout: {
                    name: 'cose',
                    idealEdgeLength: 100,
                    nodeOverlap: 20,
                    refresh: 20,
                    fit: true,
                    padding: 30,
                    randomize: false,
                    componentSpacing: 100,
                    nodeRepulsion: 400000,
                    edgeElasticity: 100,
                    nestingFactor: 5,
                    gravity: 80,
                    numIter: 1000,
                    initialTemp: 200,
                    coolingFactor: 0.95,
                    minTemp: 1.0
                }
            });

            log('Cytoscape.js initialized successfully');

         
            // Function to add nodes dynamically
            window.addNode = function() {
                try {
                    var id = 'n' + Date.now();
                    cy.add({ data: { id: id } });
                    cy.layout({ name: 'cose', animate: true }).run();
                    log('Added node: ' + id);
                } catch (e) {
                    log('Error adding node: ' + e.message);
                }
            };
			
			
            window.loadCytoscapeData = function(data) {
                log("loadCytoscapeData function called");
                try {
                    if (typeof data === 'string') {
                        log("Parsing data string to JSON");
                        data = JSON.parse(data);
                    }
                    
                    var elements = (data && Array.isArray(data.elements)) ? data.elements : [];
					let options = {
					  name: 'circle',

					  fit: true, // whether to fit the viewport to the graph
					  padding: 30, // the padding on fit
					  boundingBox: undefined, // constrain layout bounds; { x1, y1, x2, y2 } or { x1, y1, w, h }
					  avoidOverlap: true, // prevents node overlap, may overflow boundingBox and radius if not enough space
					  nodeDimensionsIncludeLabels: false, // Excludes the label when calculating node bounding boxes for the layout algorithm
					  spacingFactor: undefined, // Applies a multiplicative factor (>0) to expand or compress the overall area that the nodes take up
					  radius: undefined, // the radius of the circle
					  startAngle: 3 / 2 * Math.PI, // where nodes start in radians
					  sweep: undefined, // how many radians should be between the first and last node (defaults to full circle)
					  clockwise: true, // whether the layout should go clockwise (true) or counterclockwise/anticlockwise (false)
					  sort: undefined, // a sorting function to order the nodes; e.g. function(a, b){ return a.data('weight') - b.data('weight') }
					  animate: false, // whether to transition the node positions
					  animationDuration: 500, // duration of animation in ms if enabled
					  animationEasing: undefined, // easing of animation if enabled
					  animateFilter: function ( node, i ){ return true; }, // a function that determines whether the node should be animated.  All nodes animated by default on animate enabled.  Non-animated nodes are positioned immediately when the layout starts
					  ready: undefined, // callback on layoutready
					  stop: undefined, // callback on layoutstop
					  transform: function (node, position ){ return position; } // transform a given node position. Useful for changing flow direction in discrete layouts 

					};
                    if (elements.length > 0) {
                        log("Adding elements to Cytoscape instance.");
                        cy.elements().remove();
                        cy.add(elements);
                        cy.layout(options).run();
                        log('Cytoscape data loaded from Java');
                    } else {
                        log('No data to display. Clearing graph.');
                        cy.elements().remove(); // Clear the graph if no data
                    }
                } catch (e) {
                    log('Error loading Cytoscape data: ' + e.message);
                }
            };

		
            // Ensure proper resizing for JavaFX WebView
			
            window.addEventListener('resize', function() {
                cy.resize();
                cy.fit();
            });
        } catch (e) {
            log('Error initializing Cytoscape.js: ' + e.message);
        }
    </script>
</body>
</html>